/**
 * Generates an HTML fax cover sheet for requesting missing insurance information.
 *
 * @param {Object} params
 * @param {string} params.payerName        — Name of the insurance payer
 * @param {string} params.payerFaxNumber   — Payer fax number
 * @param {string} params.practiceName     — Sending practice name
 * @param {string} params.practiceNpi      — Practice NPI number
 * @param {string} params.returnFax        — Practice fax number for responses
 * @param {string} params.returnEmail      — Practice email for responses
 * @param {string} params.patientName      — Patient full name
 * @param {string} params.memberId         — Insurance member ID
 * @param {string} params.patientDob       — Patient date of birth
 * @param {string[]} params.missingFields  — List of missing information descriptions
 * @param {string} [params.appointmentDate] — Upcoming appointment date
 * @returns {string} HTML string for the fax cover sheet
 */
export function generateFaxCoverSheet({
  payerName,
  payerFaxNumber,
  practiceName,
  practiceNpi,
  returnFax,
  returnEmail,
  patientName,
  memberId,
  patientDob,
  missingFields = [],
  appointmentDate,
  isMedicaid = false,
  medicaidState = null,
}) {
  const today = new Date().toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });

  const missingList = missingFields
    .map(
      (f) =>
        `<tr><td style="padding:6px 12px;border-bottom:1px solid #e5e5e5;font-size:13px;color:#1a1a1a;">• ${escapeHtml(f)}</td></tr>`
    )
    .join("\n");

  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Information Request — ${escapeHtml(patientName)}</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 40px; color: #1a1a1a; }
    .header { border-bottom: 3px solid #14B8A6; padding-bottom: 16px; margin-bottom: 24px; }
    .header h1 { font-size: 22px; margin: 0 0 4px; color: #0f172a; }
    .header p { font-size: 12px; margin: 0; color: #64748b; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .section-label { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; padding: 12px 0 6px; }
    .info-table td { padding: 4px 0; font-size: 13px; }
    .info-table td:first-child { font-weight: 700; width: 160px; color: #334155; }
    .urgency { background: #fef3c7; border: 1px solid #fbbf24; border-radius: 6px; padding: 12px 16px; margin: 20px 0; font-size: 12px; color: #92400e; font-weight: 700; }
    .footer { margin-top: 32px; border-top: 1px solid #e2e8f0; padding-top: 16px; font-size: 11px; color: #94a3b8; }
    .footer strong { color: #64748b; }
  </style>
</head>
<body>
  <div class="header">
    <h1>${escapeHtml(practiceName)}</h1>
    <p>NPI: ${escapeHtml(practiceNpi || "N/A")} &nbsp;|&nbsp; Fax: ${escapeHtml(returnFax || "N/A")} &nbsp;|&nbsp; Email: ${escapeHtml(returnEmail || "N/A")}</p>
  </div>

  <div style="font-size:18px;font-weight:900;color:#0f172a;margin-bottom:20px;">
    ${isMedicaid ? `REQUEST FOR MEDICAID DENTAL BENEFIT INFORMATION${medicaidState ? ` (${escapeHtml(medicaidState)})` : ""}` : "REQUEST FOR MISSING BENEFIT INFORMATION"}
  </div>

  <div class="section-label">TO</div>
  <table class="info-table">
    <tr><td>${isMedicaid ? "State Medicaid Program" : "Payer"}</td><td>${escapeHtml(payerName)}</td></tr>
    <tr><td>Fax Number</td><td>${escapeHtml(payerFaxNumber)}</td></tr>
  </table>

  <div class="section-label">RE: PATIENT</div>
  <table class="info-table">
    <tr><td>Patient Name</td><td>${escapeHtml(patientName)}</td></tr>
    <tr><td>${isMedicaid ? "Medicaid ID" : "Member ID"}</td><td>${escapeHtml(memberId || "N/A")}</td></tr>
    <tr><td>Date of Birth</td><td>${escapeHtml(patientDob || "N/A")}</td></tr>
    ${appointmentDate ? `<tr><td>Appointment Date</td><td>${escapeHtml(appointmentDate)}</td></tr>` : ""}
  </table>

  <div class="section-label">MISSING INFORMATION REQUESTED</div>
  <table style="border:1px solid #e5e5e5;border-radius:6px;overflow:hidden;">
    ${missingList || '<tr><td style="padding:8px 12px;font-size:13px;color:#94a3b8;">No specific fields listed</td></tr>'}
  </table>

  ${appointmentDate ? `<div class="urgency">⚠️ TIME-SENSITIVE — Patient has an appointment scheduled for ${escapeHtml(appointmentDate)}. Prompt response appreciated.</div>` : ""}

  <div class="section-label">PLEASE RESPOND VIA</div>
  <table class="info-table">
    ${returnFax ? `<tr><td>Fax</td><td>${escapeHtml(returnFax)}</td></tr>` : ""}
    ${returnEmail ? `<tr><td>Email</td><td>${escapeHtml(returnEmail)}</td></tr>` : ""}
  </table>

  <div class="footer">
    <strong>Date:</strong> ${today}<br/>
    <strong>From:</strong> ${escapeHtml(practiceName)}<br/>
    This fax was generated by Level AI on behalf of the above dental practice.
    This communication may contain protected health information (PHI) and is intended
    solely for the addressee. If you received this in error, please notify the sender immediately.
  </div>
</body>
</html>`;
}

/** Escape HTML special characters */
function escapeHtml(str) {
  if (!str) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}

/**
 * Maps verification failure flags to human-readable missing field descriptions.
 * Used to build the fax cover sheet's "missing information" list.
 *
 * @param {Object} result — The verification result object
 * @returns {string[]} Array of missing field descriptions
 */
export function extractMissingFields(result) {
  const fields = [];
  const flags = result?.actionFlags || {};
  const meta = result?.meta || {};
  const cat = result?._failCategory;
  const isMedicaid = result?._is_medicaid || false;
  const medState = result?._medicaid_state || "";

  if (isMedicaid) {
    // ── Medicaid-specific missing fields ────────────────────────────────
    const medInfo = result?.medicaid_info || {};
    if (!medInfo.covered_categories || medInfo.covered_categories.length === 0)
      fields.push(`${medState} Medicaid covered dental service categories`);
    if (!medInfo.frequency_limits || Object.keys(medInfo.frequency_limits).length === 0)
      fields.push(`Frequency limitations for preventive and restorative procedures (${medState})`);
    if (medInfo.prior_auth_required !== false && (!medInfo.prior_auth_codes || medInfo.prior_auth_codes.length === 0))
      fields.push(`Prior authorization requirements by CDT code (${medState} Medicaid)`);
    if (medInfo.copay_schedule == null)
      fields.push(`Copay schedule by procedure type (${medState} Medicaid)`);
    if (flags.missing_tooth_clause)
      fields.push("Missing/replacement tooth clause details under state Medicaid plan");
    if (flags.waiting_period_active)
      fields.push("Waiting period end date for Medicaid dental coverage");
    if (cat === "missing_member_id")
      fields.push("Medicaid ID verification — unable to locate member in state system");
    if (cat === "payer_unsupported" || cat === "payer_system_error")
      fields.push(`Complete Medicaid dental benefit breakdown — electronic verification unavailable for ${medState}`);
    if (fields.length === 0)
      fields.push(`Medicaid dental eligibility confirmation and benefit details (${medState})`);
  } else {
    // ── Commercial insurance missing fields ─────────────────────────────
    if (flags.missing_tooth_clause)
      fields.push("Missing tooth clause details (replacement history and clause language)");
    if (flags.pre_auth_required)
      fields.push("Pre-authorization requirements and submission address");
    if (flags.waiting_period_active)
      fields.push("Waiting period end date and applicable service categories");
    if (flags.frequency_limit_reached)
      fields.push("Frequency limitation reset dates for applicable procedures");
    if (flags.annual_max_low)
      fields.push("Current annual maximum remaining and plan year reset date");
    if (flags.cob_active)
      fields.push("Coordination of Benefits (COB) — secondary payer information");
    if (flags.ortho_lifetime_max)
      fields.push("Orthodontic lifetime maximum and remaining benefit amount");

    // Fail categories → broader missing data
    if (cat === "missing_member_id")
      fields.push("Subscriber/member ID verification — unable to locate member in system");
    if (cat === "payer_unsupported")
      fields.push("Complete benefit breakdown — electronic verification unavailable for this payer");
    if (cat === "payer_system_error")
      fields.push("Complete benefit breakdown — payer system returned an error during verification");

    // Missing deductible/coinsurance data
    if (meta.deductibleIndividual == null && meta.deductibleFamily == null)
      fields.push("Individual and family deductible amounts with year-to-date applied");
    if (meta.coinsurance == null)
      fields.push("Coinsurance percentages by service category (preventive, basic, major)");
  }

  return fields;
}
