// ═══════════════════════════════════════════════════════════════════════════════
// HIPAA COMPLIANCE — ZERO PHI AT REST
//
// This database stores ONLY business configuration (Practice, billing, audit).
// NO patient data (names, DOBs, member IDs, insurance) is persisted here.
//
// Patient data lifecycle:
//   PMS (Open Dental) → Encrypted Redis Cache (AES-256-GCM) → Browser State
//   TTL: 24 hours max, expires at 11 PM daily. See lib/patientCache.js
//
// Verification results: returned directly to frontend, stored in React state
//   only. Never written to Postgres. See app/api/v1/verify/route.js
//
// Audit logs: contain action metadata (counts, status codes) — never PHI.
//   See lib/audit.js
//
// Migration 20260221_drop_phi_tables removed the legacy Patient and
// VerificationResult tables that were created in the initial schema.
// ═══════════════════════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── A dental practice (one per Clerk user on signup) ─────────────────────────
model Practice {
  id          String   @id @default(cuid())
  clerkUserId String   @unique
  name        String
  email       String?                          // primary contact / outbox email (required after onboarding)
  npi         String?
  taxId       String?
  accountMode String   @default("sandbox")  // "sandbox" | "live"
  status      String   @default("active")   // "active" | "suspended" | "cancelled"
  address     String?
  phone       String?
  pmsSystem     String?                        // "Open Dental" | "Dentrix" | "Eaglesoft"
  pmsSyncKey    String?                        // encrypted PMS sync key / eKey
  webhookSecret String?                        // per-practice HMAC secret for PMS webhooks
  faxNumber     String?                        // practice fax for receiving payer info requests
  verificationDaysAhead Int @default(7)        // 1-25 days ahead to auto-verify schedule
  activatedAt   DateTime?                      // set when activation code is redeemed

  // ── Stripe billing ──
  stripeCustomerId       String?   @unique     // Stripe customer ID (cus_xxx)
  stripeSubscriptionId   String?               // Stripe subscription ID (sub_xxx)
  stripeSubscriptionStatus String?             // "trialing" | "active" | "past_due" | "canceled"
  planTier               String?   @default("starter") // "starter" | "professional" | "enterprise"

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  auditLogs           AuditLog[]
  flaggedIssues       FlaggedIssue[]
}

// ── Audit log for PHI access and sensitive operations ─────────────────────────
// ZERO PHI AT REST: Audit logs contain action metadata only — no patient names,
// DOBs, phone numbers, member IDs, or insurance details.
model AuditLog {
  id           String   @id @default(cuid())
  practiceId   String?
  practice     Practice? @relation(fields: [practiceId], references: [id])
  userId       String?               // Clerk userId or "webhook"
  action       String                // e.g. "verify.eligibility", "pms.sync"
  resourceType String?               // e.g. "Schedule", "Medicaid"
  resourceId   String?               // ID of the accessed resource
  ipAddress    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([practiceId])
  @@index([action])
  @@index([createdAt])
}

// ── Flagged Payer Pal issues (escalated by front-desk staff) ─────────────────
// Stores questions/answers that Payer Pal couldn't handle well, for admin review.
model FlaggedIssue {
  id            String    @id @default(cuid())
  practiceId    String?
  practice      Practice? @relation(fields: [practiceId], references: [id])
  userId        String?               // Clerk userId who flagged it
  patientId     String?               // Patient ID (not PHI — just the schedule ID like "p4")
  question      String                // The user question that was flagged
  aiResponse    String?               // The AI response (or error) that triggered the flag
  errorType     String?               // "service_error", "config_error", "timeout", "unknown", etc.
  status        String    @default("open") // "open" | "reviewed" | "resolved"
  adminNotes    String?               // Admin can annotate
  createdAt     DateTime  @default(now())
  resolvedAt    DateTime?

  @@index([practiceId])
  @@index([status])
  @@index([createdAt])
}

// ── Activation codes (one-time license keys issued after payment) ──────────
model ActivationCode {
  id            String    @id @default(cuid())
  code          String    @unique              // e.g. "LVL-8F3K-X9M2"
  label         String?                        // admin note, e.g. "Dr. Smith — Smile Dental"
  customerEmail String?                        // email of the customer the code was generated for
  used          Boolean   @default(false)
  usedBy        String?                        // Practice.id of the practice that redeemed it
  createdAt     DateTime  @default(now())
  usedAt        DateTime?
}
