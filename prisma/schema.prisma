generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── A dental practice (one per Clerk user on signup) ─────────────────────────
model Practice {
  id          String   @id @default(cuid())
  clerkUserId String   @unique
  name        String
  npi         String?
  taxId       String?
  accountMode String   @default("sandbox")  // "sandbox" | "live"
  address     String?
  phone       String?
  pmsSystem   String?                        // "Open Dental" | "Dentrix" | "Eaglesoft"
  pmsSyncKey  String?                        // encrypted PMS sync key / eKey
  activatedAt DateTime?                      // set when activation code is redeemed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  patients            Patient[]
  verificationResults VerificationResult[]
  smsQueue            SmsQueue[]
  auditLogs           AuditLog[]
}

// ── A patient record belonging to a practice ─────────────────────────────────
model Patient {
  id          String   @id @default(cuid())
  practiceId  String
  practice    Practice @relation(fields: [practiceId], references: [id])

  externalId  String?
  firstName   String
  lastName    String
  dateOfBirth String
  phone       String?
  email       String?
  gender      String?                        // "M" | "F"

  memberId      String?
  groupNumber   String?
  insuranceName String?
  payerId       String?

  procedure       String?
  provider        String?
  appointmentDate String?
  appointmentTime String?
  isOON           Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  verificationResults VerificationResult[]
  smsQueue            SmsQueue[]

  @@unique([practiceId, externalId])        // prevent duplicate patients per practice
}

// ── A single eligibility verification result ─────────────────────────────────
model VerificationResult {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id])
  patientId  String?
  patient    Patient? @relation(fields: [patientId], references: [id])

  memberIdUsed       String?
  payerIdUsed        String?
  trigger            String?

  verificationStatus String
  planStatus         String?
  payerName          String?
  source             String
  rawResponse        Json?
  normalizedResult   Json

  verifiedAt DateTime @default(now())
  durationMs Int?
}

// ── SMS draft queue (approve-before-send outreach) ────────────────────────────
model SmsQueue {
  id             String    @id @default(cuid())
  practiceId     String
  practice       Practice  @relation(fields: [practiceId], references: [id])
  patientId      String?
  patient        Patient?  @relation(fields: [patientId], references: [id])

  recipientPhone String
  recipientName  String?
  draftMessage   String
  triggerType    String              // "reschedule_proposed" | "outreach_queued"
  status         String    @default("draft")  // draft | approved | sent | failed | dismissed
  approvedBy     String?             // clerkUserId who approved
  approvedAt     DateTime?
  sentAt         DateTime?
  twilioSid      String?             // Twilio message SID after send
  errorMessage   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ── Audit log for PHI access and sensitive operations ─────────────────────────
model AuditLog {
  id           String   @id @default(cuid())
  practiceId   String?
  practice     Practice? @relation(fields: [practiceId], references: [id])
  userId       String?               // Clerk userId or "webhook"
  action       String                // e.g. "verify.eligibility", "patient.import"
  resourceType String?               // e.g. "Patient", "SmsQueue"
  resourceId   String?               // ID of the accessed resource
  ipAddress    String?
  metadata     Json?
  createdAt    DateTime @default(now())

  @@index([practiceId])
  @@index([action])
  @@index([createdAt])
}

// ── Activation codes (one-time license keys issued after payment) ──────────
model ActivationCode {
  id            String    @id @default(cuid())
  code          String    @unique              // e.g. "LVL-8F3K-X9M2"
  label         String?                        // admin note, e.g. "Dr. Smith — Smile Dental"
  customerEmail String?                        // email of the customer the code was generated for
  used          Boolean   @default(false)
  usedBy        String?                        // Practice.id of the practice that redeemed it
  createdAt     DateTime  @default(now())
  usedAt        DateTime?
}
